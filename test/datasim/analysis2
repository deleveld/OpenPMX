#
#
# removed zero observation !!!
# @55,36,0,100,0,Err:502
#
#
set -eu
TEMP=$(mktemp -d)
trap "rmdir --ignore-fail-on-non-empty $TEMP" EXIT
export LC_ALL=C

# inform user if we fail prematurely
COMPLETION_MESSAGE="WARNING: The script ${0} failed somewhere! The results may not be reliable!!!"
function inform_error_state {
	echo $COMPLETION_MESSAGE
}
trap inform_error_state EXIT

METHODNAME="${1:-}"

if [ "${METHODNAME}" = "nlmixr2" ]; then
	echo You must run
	echo conda activate nlmixr2
	echo before this, and then comment out this
#	exit
fi

if [ "${METHODNAME}" != "" ]; then
	(cd ../../; ./install)
	./generate_results "${METHODNAME}"
fi

R --vanilla --slave <<-RSCRIPT
########################################################################
# problem specific models
	source("models/_true_values.R")
########################################################################

	nonmem <- readin("generate_results.nonmem.txt")

	if (file.exists("generate_results.nonmemsaem.txt"))
		nonmemsaem <- readin("generate_results.nonmemsaem.txt")

	if (file.exists("generate_results.nonmemitsb.txt"))
		nonmemitsb <- readin("generate_results.nonmemitsb.txt")

	if (file.exists("generate_results.openpmx.txt"))
		gronmem <- readin("generate_results.openpmx.txt")

	if (file.exists("generate_results.validate.txt"))
		validate <- readin("generate_results.validate.txt")

	if (file.exists("generate_results.openpmxicov.txt"))
		gronmemicov <- readin("generate_results.openpmxicov.txt")
	
#	nonmemlaplace   <- readin("generate_results.nonmemlaplace.txt")
#	gronmemtest 	<- readin("generate_results.openpmxtest.txt")

	postscript(file="${TEMP}/${0}.ps", horizontal=TRUE)
	source("../utils/analysis_tables_and_plots.R")
	source("../utils/analysis_tables_and_plots2.R")
	
	write.csv(tabbias, file="bias.csv")
	write.csv(tabrmse, file="rmse.csv")

RSCRIPT

../utils/_write_figures.sh "${0}" "${TEMP}/${0}.ps"
	
# tell the user it worked when we exit
COMPLETION_MESSAGE=""

