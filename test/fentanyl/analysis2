Oset -eu
TEMP=$(mktemp -d)
trap "rmdir --ignore-fail-on-non-empty $TEMP" EXIT
export LC_ALL=C

# inform user if we fail prematurely
COMPLETION_MESSAGE="WARNING: The script ${0} failed somewhere! The results may not be reliable!!!"
function inform_error_state {
	echo $COMPLETION_MESSAGE
}
trap inform_error_state EXIT

METHODNAME="${1:-}"

if [ "${METHODNAME}" != "" ]; then
	(cd ../../; ./install)
	./generate_results "${METHODNAME}"
fi

R --vanilla --slave <<-RSCRIPT
########################################################################
# problem specific models
	source("models/_true_values.R")
########################################################################

	nonmem <- readin("generate_results.nonmem.txt")
	nonmem_ms <- read.table("generate_results.nonmem.runtime_ms.txt", header=FALSE)

	if (file.exists("generate_results.openpmx.txt")) {
		gronmem <- readin("generate_results.openpmx.txt")
		gronmem_ms <- read.table("generate_results.openpmx.runtime_ms.txt", header=FALSE)
	}
	if (file.exists("generate_results.validate.txt")) {
		validate <- readin("generate_results.validate.txt")
		validate_ms <- read.table("generate_results.validate.runtime_ms.txt", header=FALSE)
	}

	postscript(file="${TEMP}/${0}.ps", horizontal=TRUE)
	source("../utils/analysis_tables_and_plots.R")
	median_speed_offset_x <- 6
	median_speed_offset_y <- 0.2
	source("../utils/analysis_tables_and_plots2.R")
	
RSCRIPT

../utils/_write_figures.sh "${0}" "${TEMP}/${0}.ps"
	
# tell the user it worked when we exit
COMPLETION_MESSAGE=""

