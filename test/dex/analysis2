set -eu
TEMP=$(mktemp -d)
trap "rmdir --ignore-fail-on-non-empty $TEMP" EXIT
export LC_ALL=C

# inform user if we fail prematurely
COMPLETION_MESSAGE="WARNING: The script ${0} failed somewhere! The results may not be reliable!!!"
function inform_error_state {
	echo $COMPLETION_MESSAGE
}
trap inform_error_state EXIT

if [ "${1}" = "generate" ]; then
	(cd ../../; ./install)
	./generate_results
fi

R --vanilla --slave <<-RSCRIPT
	trueparams <- list(
		c(tabname="THETA1", 	trueval=6.046010e-01,	label="V1",				logv=TRUE,		units="(l)"),
		c(tabname="THETA2", 	trueval=3.326570e+00,	label="V2",				logv=TRUE,		units="(l)"),
		c(tabname="THETA3", 	trueval=3.997030e+00, 	label="V3",				logv=TRUE,		units="(l)"),
		c(tabname="THETA4", 	trueval=-3.641990e-01, 	label="CL",				logv=TRUE,		units="(l/min)"),
		c(tabname="THETA5", 	trueval=1.178030e+00, 	label="Q2",				logv=TRUE,		units="(l/min)"),
		c(tabname="THETA6", 	trueval=-3.720650e-01, 	label="Q3",				logv=TRUE,		units="(l/min)"),
		c(tabname="OMEGA.1.1.", trueval=3.50E-02, 		label="var(V1)",		logv=FALSE,		units=""),
		c(tabname="OMEGA.2.2.", trueval=2.73E-01, 		label="IO var(V1)",		logv=FALSE,		units=""),
		c(tabname="OMEGA.4.4.", trueval=6.33E-02, 		label="var(V3)",		logv=FALSE,		units=""),
		c(tabname="OMEGA.5.5.", trueval=2.76E-02, 		label="var(CL)",		logv=FALSE,		units=""),
		c(tabname="SIGMA.1.1.", trueval=3.63E-02, 		label="var(residual)",	logv=FALSE,		units=""))

	gronmem <- 		read.table(file="generate_results.openpmx.txt", header=TRUE)
#	gronmemicov <-	read.table(file="generate_results.openpmxicov.txt", header=TRUE)
#	gronmemtest <-	read.table(file="generate_results.openpmxtest.txt", header=TRUE)
	nonmem <- 		read.table(file="generate_results.nonmem.txt", header=TRUE)
#	nonmemlaplace <- read.table(file="generate_results.nonmemlaplace.txt", header=TRUE)

#######################################################################

	setup_par <- function()
	{
		par(mfrow=c(3, 4), mar=c(2,2,2,0), oma=c(0,0,1,1), cex=0.9)
	}

########################################################################
	postscript(file="${TEMP}/${0}.ps", horizontal=TRUE)
	source("../utils/analysis_tables_and_plots.R")
	source("../utils/analysis_tables_and_plots2.R")
RSCRIPT

../utils/_write_figures.sh dex ${TEMP}/${0}.ps

# tell the user it worked when we exit
COMPLETION_MESSAGE=""

