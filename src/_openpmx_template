########################################################################
#
# This file is part of OpenPMX (https://github.com/deleveld/openpmx).
# Copyright (c) 2024 Douglas Eleveld.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

FILE="${1}"
DATA="${2:-}"

# control, object, and executable
BASE=$(basename "${FILE}")
OBJFILE="${BASE}.o"
EXECFILE="${FILE}.bin"

# dont allow recursive runs, for server the lock is in the OpenPMX
# install directory so only a single run per install is done.
MAX_RETRIES=60  # (60 retries * 10s = 10 minute total timeout)
RETRY_COUNT=0
while ! mkdir "$LOCKDIR" 2>/dev/null; do
    if [ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]; then
        printf "error: timeout reached. Could not acquire lock after %ds.\n" $((MAX_RETRIES * 10)) >&2
        exit 1
    fi
    printf "... waiting 10s for previous run to finish (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)\n" >&2
    sleep 10
    ((RETRY_COUNT++))
done

# cleanup when done
EXITMESSAGE="error: openpmx failed\n"
cleanup() {
	printf "${EXITMESSAGE}"
	rm "${OBJFILE}" 2>/dev/null || true
	rm "${EXECFILE}" 2>/dev/null || true
	rmdir "$LOCKDIR" 2>/dev/null || true
}
trap cleanup EXIT

# Set platform-specific variables
if [[ "$PLATFORM" == "msys2" ]]; then
	EXECFILE="${FILE}.exe"
fi

# translate control file to C code
if [ "${FILE##*.}" != "c" ]; then
	"${OPENPMXPATH}/bin/openpmxtran" "${FILE}" "${DATA}" 2>&1
	FILE="${FILE}.c"
fi

# compile the C code
# only show relative paths
(${CC} ${CFLAGS} -fdebug-prefix-map=$(pwd)=. -I"${OPENPMXPATH}/include" -c "${FILE}" -o "${OBJFILE}") 2>&1

# we have object files, so link now
(${CC} "${OBJFILE}" -o "${EXECFILE}" -L"${OPENPMXPATH}/lib" ${LFLAGS} -lopenpmx -lgsl -lgslcblas -lm) 2>&1

# execute and clear exit message
if "./${EXECFILE}" 2>&1; then
	EXITMESSAGE=""
fi
