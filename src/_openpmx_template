########################################################################
#
# This file is part of OpenPMX (https://github.com/deleveld/openpmx).
# Copyright (c) 2024 Douglas Eleveld.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

FILE="${1}"

# control, object, and executable
BASE=$(basename "${FILE}")
OBJFILE="${BASE}.o"
EXECFILE="${FILE}.bin"

# dont allow recursive runs
LOCKDIR="${FILE}.lockdir"
while ! mkdir "$LOCKDIR" 2>/dev/null; do
	printf "... waiting 10s for previous run to finish \"${LOCKDIR}\"\n" >&2
    sleep 10
done

# Set platform-specific variables
if [[ "$PLATFORM" == "msys2" ]]; then
	EXECFILE="${FILE}.exe"
fi

# cleanup when done
EXITMESSAGE="error: openpmx failed\n"
cleanup() {
	printf "${EXITMESSAGE}"
	rm "${OBJFILE}" 2>/dev/null || true
	rm "${EXECFILE}" 2>/dev/null || true
	rmdir "$LOCKDIR" 2>/dev/null || true
}
trap cleanup EXIT

# translate control file to C code
if [ "${FILE##*.}" != "c" ]; then
	"${OPENPMXPATH}/bin/openpmxtran" "${FILE}" 2>&1
	FILE="${FILE}.c"
fi

# compile the C code
# only show relative paths
(${CC} ${CFLAGS} -fdebug-prefix-map=$(pwd)=. -I"${OPENPMXPATH}/include" -c "${FILE}" -o "${OBJFILE}") 2>&1

# we have object files, so link now
(${CC} "${OBJFILE}" -o "${EXECFILE}" -L"${OPENPMXPATH}/lib" ${LFLAGS} -lopenpmx -lgsl -lgslcblas -lm) 2>&1

# execute and clear exit message
if "./${EXECFILE}" 2>&1; then
	EXITMESSAGE=""
fi
