#!/bin/bash
########################################################################
#
# This file is part of OpenPMX (https://github.com/deleveld/openpmx).
# Copyright (c) 2024 Douglas Eleveld.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -euo pipefail

# handle command line arguments
TARGET="pthread"
SERVER="notserver"
while (( $# )); do
    case $1 in
        pthread)
			TARGET="pthread"
            ;;
        openmp)
			TARGET="openmp"
            ;;
        singlethread)
			TARGET="singlethread"
            ;;
        server)
            SERVER="server"
            ;;
        notserver)
            SERVER="notserver"
            ;;
        clean)
			TARGET="clean"
            ;;
        --help)
			printf "This file installs OpenPMX (https://github.com/deleveld/openpmx).\n"
			exit 1
			;;
        *)
			printf "error: argument %s not recognized\n" "${1}" >&2
			exit 1
            ;;
    esac
    shift
done

# print success/failed message when done
EXITMESSAGE="failed"
cleanup() {
	printf "openpmx install $EXITMESSAGE\n"
}
trap cleanup EXIT

# find out about the platform and the path 
detect_platform() {
    case "$OSTYPE" in
        darwin*)  echo "macos" ;;
        msys*)    echo "msys2" ;;
        linux*)    echo "linux" ;;
        *)
            if grep -qi microsoft /proc/version 2>/dev/null; then
                echo "wsl"
            else
                echo "unknown"
            fi
            ;;
    esac
}
PLATFORM=$(detect_platform)
OPENPMXPATH=$(cd "$(dirname "${0}")" && pwd)
printf "install %s %s %s\n" "${TARGET}" "${SERVER}" "${PLATFORM}" 
printf "path %s\n" "${OPENPMXPATH}"

# cleaup previous build
mkdir -p "${OPENPMXPATH}/build" "${OPENPMXPATH}/bin" "${OPENPMXPATH}/lib"
printf "clean\n"
rm -vf "${OPENPMXPATH}"/build/*.o
rm -vf "${OPENPMXPATH}"/bin/openpmxtran
rm -vf "${OPENPMXPATH}"/lib/*.a
rm -vf "${OPENPMXPATH}/openpmx"
rm -vf "${OPENPMXPATH}/src/buildflags.h"
if [ "${TARGET}" = "clean" ]; then
    exit 0
fi

# general build flags
CC="${CC:-gcc}"
LIBNAME="openpmx"
CFLAGS="-g -O2 -W -Wall -Wextra"
CLIBFLAGS="-Wfloat-conversion -Wformat -Werror=format-security -Wno-override-init -Wwrite-strings -Isrc"
LFLAGS=""
AR="ar rcs lib/lib${LIBNAME}.a"

# adjust flags for different platforms
case "${PLATFORM}" in
    macos*)
        # macOS-specific flags
        # Remove -march=native as it's not well supported on Apple Silicon
        # Use -fPIC for position independent code
        CLIBFLAGS="${CLIBFLAGS} -fPIC"
        # Detect architecture
        ARCH=$(uname -m)
        if [ "$ARCH" = "arm64" ]; then
            # Apple Silicon
            CFLAGS="${CFLAGS} -mcpu=apple-m1"
        else
            # Intel Mac
            CFLAGS="${CFLAGS} -march=native"
        fi
        LFLAGS="${LFLAGS} -flto"
        ;;
    linux*|wsl*)
        CFLAGS="${CFLAGS} -march=native"
        CLIBFLAGS="${CLIBFLAGS} -fPIC"
        LFLAGS="${LFLAGS} -static -flto"
        ;;
    msys2*)
        CFLAGS="${CFLAGS} -march=native -I/mingw64/include"
        LFLAGS="${LFLAGS} -L\"${OPENPMXPATH}/lib\" -L/mingw64/lib"
        LFLAGS="${LFLAGS} -static -flto"
        ;;
    *)
        printf "error: platform %s not recognized\n" "${PLATFORM}" >&2
        exit 1
        ;;
esac

# initialize build flags
{
    printf "#define OPENPMX_INSTALL_PLATFORM \"%s\"\n" "${PLATFORM}"
    printf "#define OPENPMX_INSTALL_PATH \"%s\"\n" "${OPENPMXPATH}"
} >> "${OPENPMXPATH}/src/buildflags.h"

# handle different flags for targets
case "${TARGET}" in
    openmp)
        CFLAGS="${CFLAGS} -fopenmp"
        LFLAGS="${LFLAGS} -fopenmp -lgomp"
        printf "#define OPENPMX_PARALLEL_OPENMP\n" >> "${OPENPMXPATH}/src/buildflags.h"
        ;;
    pthread)
        CFLAGS="${CFLAGS} -pthread"
        LFLAGS="${LFLAGS} -pthread"
        printf "#define OPENPMX_PARALLEL_PTHREADS\n" >> "${OPENPMXPATH}/src/buildflags.h"
        ;;
    singlethread)
        printf "#define OPENPMX_PARALLEL_SINGLETHREAD\n" >> "${OPENPMXPATH}/src/buildflags.h"
        ;;
    *)
        printf "error: target \"%s\" not recognized\n" "${TARGET}" >&2
        exit 1
        ;;
esac

# for server the lockdir is in the install dir so only a single instance
# can run per install, others wait until they can
case "${SERVER}" in
    server)
		LOCKDIR="${OPENPMXPATH}/openpmx.lockdir"
        printf "#define OPENPMX_SERVER\n" >> "${OPENPMXPATH}/src/buildflags.h"
		;;
    notserver)
		LOCKDIR="openpmx.lockdir"
        printf "#define OPENPMX_NOTSERVER\n" >> "${OPENPMXPATH}/src/buildflags.h"
        ;;
    *)
        printf "error: server \"%s\" not recognized\n" "${SERVER}" >&2
        exit 1
        ;;
esac

# compile openpmxtran
printf "compile openpmxtran\n"
(cd "${OPENPMXPATH}" && ${CC} ${CFLAGS} "src/openpmxtran.c" -o "bin/openpmxtran" ${LFLAGS} -lm)

# compile source code to object files
SOURCEFILES="pmxstate.c options.c ievaluate.c predict.c stage1.c
			 checkout.c popmodel.c encode.c nonzero.c omegainfo.c
			 linalg.c print.c idata.c table.c scatter.c estimate.c
			 simulate.c
			 dataconfig/dataconfig.c
			 advan/advan.c advan/pred.c advan/onecomp.c
			 advan/onecomp_depot.c advan/twocomp.c advan/threecomp.c
			 advan/diffeqn_test.c advan/diffeqn_libgsl.c
			 utils/vector.c utils/various.c
			 bobyqa/bobyqa.c"
OBJECTFILES=""
for FILE in ${SOURCEFILES}; do
    printf "compile %s\n" "${FILE}"
    BASE=$(basename "${FILE}")
    OBJFILE="${BASE%.*}.o"
    (cd "${OPENPMXPATH}" && ${CC} ${CFLAGS} ${CLIBFLAGS} -Iinclude -c "src/${FILE}" -o "build/${OBJFILE}")
    OBJECTFILES="${OBJECTFILES} build/${OBJFILE}"
done

# build library from object files
printf "build library\n"
(cd "${OPENPMXPATH}" && ${AR} ${OBJECTFILES})

# write the final launcher script
printf "write openpmx script\n"
{
    printf "#!/bin/bash\n"
    printf "set -euo pipefail\n"
    printf "########################################################################\n"
    printf "# OpenPMX build options\n"
    printf "CC=%s\n" "${CC}"
    printf "CFLAGS=\"%s\"\n" "${CFLAGS}"
    printf "LFLAGS=\"%s\"\n" "${LFLAGS}"
    printf "OPENPMXPATH=\"%s\"\n" "${OPENPMXPATH}"
    printf "PLATFORM=\"%s\"\n" "${PLATFORM}"
    printf "LOCKDIR=\"%s\"\n" "${LOCKDIR}"
    cat "${OPENPMXPATH}/src/_openpmx_template"
} > "${OPENPMXPATH}/openpmx"

chmod a+x "${OPENPMXPATH}/openpmx"

# exit with success message
EXITMESSAGE="success"

